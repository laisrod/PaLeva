<div class="register-container">
  <div class="register-card">
    <h1>PaLeva</h1>
    <h2>Criar Conta</h2>
    
    <% if flash[:alert] %>
      <div class="error-message">
        <%= flash[:alert] %>
      </div>
    <% end %>

    <% if flash[:notice] %>
      <div class="success-message">
        <%= flash[:notice] %>
      </div>
    <% end %>

    <form id="registerForm">
      <div class="form-row">
        <div class="form-group">
          <label for="name">Nome</label>
          <input
            id="name"
            name="name"
            type="text"
            value=""
            placeholder="Seu nome"
            required
            autocomplete="given-name"
          />
        </div>

        <div class="form-group">
          <label for="last_name">Sobrenome</label>
          <input
            id="last_name"
            name="last_name"
            type="text"
            value=""
            placeholder="Seu sobrenome"
            required
            autocomplete="family-name"
          />
        </div>
      </div>

      <div class="form-group">
        <label for="email">Email</label>
        <input
          id="email"
          name="email"
          type="email"
          value=""
          placeholder="seu@email.com"
          required
          autocomplete="email"
        />
      </div>

      <div class="form-group">
        <label for="cpf">CPF</label>
        <input
          id="cpf"
          name="cpf"
          type="text"
          value=""
          placeholder="000.000.000-00"
          maxLength="14"
          required
        />
      </div>

      <div class="form-group">
        <label for="password">Senha</label>
        <input
          id="password"
          name="password"
          type="password"
          value=""
          placeholder="Mínimo 6 caracteres"
          required
          minLength="6"
          autocomplete="new-password"
        />
      </div>

      <div class="form-group">
        <label for="password_confirmation">Confirmar Senha</label>
        <input
          id="password_confirmation"
          name="password_confirmation"
          type="password"
          value=""
          placeholder="Digite a senha novamente"
          required
          minLength="6"
          autocomplete="new-password"
        />
      </div>

      <div id="errorMessage" class="error-message" style="display: none;"></div>
      <div id="successMessage" class="success-message" style="display: none;"></div>

      <button 
        type="submit" 
        class="btn-primary"
        id="submitButton"
      >
        <span id="buttonText">Criar Conta</span>
      </button>

      <div class="register-footer">
        <p>
          Já tem uma conta? <a href="<%= login_path %>">Faça login</a>
        </p>
      </div>
    </form>
  </div>
</div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getAuth, createUserWithEmailAndPassword, updateProfile } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

  // Configuração do Firebase
  const firebaseConfig = {
    apiKey: '<%= firebase_config[:apiKey] %>',
    authDomain: '<%= firebase_config[:authDomain] %>',
    projectId: '<%= firebase_config[:projectId] %>',
    storageBucket: '<%= firebase_config[:storageBucket] %>',
    messagingSenderId: '<%= firebase_config[:messagingSenderId] %>',
    appId: '<%= firebase_config[:appId] %>'
  };
  
  // Verificar se a API key está configurada
  if (!firebaseConfig.apiKey || firebaseConfig.apiKey === '') {
    console.error('Firebase API Key não configurada! Configure a variável de ambiente FIREBASE_API_KEY ou VITE_FIREBASE_API_KEY');
  }

  // Inicializar Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  // Formulário de registro
  const registerForm = document.getElementById('registerForm');
  const nameInput = document.getElementById('name');
  const lastNameInput = document.getElementById('last_name');
  const emailInput = document.getElementById('email');
  const cpfInput = document.getElementById('cpf');
  const passwordInput = document.getElementById('password');
  const passwordConfirmationInput = document.getElementById('password_confirmation');
  const errorMessage = document.getElementById('errorMessage');
  const successMessage = document.getElementById('successMessage');
  const submitButton = document.getElementById('submitButton');
  const buttonText = document.getElementById('buttonText');

  // Formatação de CPF
  function formatCPF(value) {
    const cpf = value.replace(/\D/g, '');
    if (cpf.length <= 11) {
      return cpf
        .replace(/(\d{3})(\d)/, '$1.$2')
        .replace(/(\d{3})(\d)/, '$1.$2')
        .replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    }
    return value;
  }

  cpfInput.addEventListener('input', (e) => {
    e.target.value = formatCPF(e.target.value);
  });

  // Validação do formulário
  function validateForm() {
    const name = nameInput.value.trim();
    const lastName = lastNameInput.value.trim();
    const email = emailInput.value.trim();
    const cpf = cpfInput.value.trim();
    const password = passwordInput.value;
    const passwordConfirmation = passwordConfirmationInput.value;

    if (!name) {
      showError('Nome é obrigatório');
      return false;
    }
    if (!lastName) {
      showError('Sobrenome é obrigatório');
      return false;
    }
    if (!email) {
      showError('Email é obrigatório');
      return false;
    }
    if (!cpf) {
      showError('CPF é obrigatório');
      return false;
    }
    if (password.length < 6) {
      showError('Senha deve ter pelo menos 6 caracteres');
      return false;
    }
    if (password !== passwordConfirmation) {
      showError('As senhas não coincidem');
      return false;
    }
    return true;
  }

  registerForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Limpar mensagens anteriores
    errorMessage.style.display = 'none';
    successMessage.style.display = 'none';
    
    if (!validateForm()) {
      return;
    }

    const name = nameInput.value.trim();
    const lastName = lastNameInput.value.trim();
    const email = emailInput.value.trim();
    const cpf = cpfInput.value.replace(/\D/g, ''); // Remover formatação
    const password = passwordInput.value;

    // Desabilitar botão e mostrar loading
    submitButton.disabled = true;
    buttonText.textContent = 'Cadastrando...';

    try {
      // 1. Criar usuário no Firebase
      const displayName = `${name} ${lastName}`.trim();
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      const user = userCredential.user;
      
      // Atualizar displayName no Firebase
      await updateProfile(user, { displayName: displayName });
      
      // Aguardar um pouco para garantir que o token está disponível
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      // Obter token do Firebase
      const token = await user.getIdToken(true); // Forçar refresh
      
      // 2. Criar usuário no backend Rails
      const response = await fetch('/api/v1/users', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({
          user: {
            name: name,
            last_name: lastName,
            email: email,
            cpf: cpf
          }
        })
      });

      const data = await response.json();

      if (!response.ok) {
        // Se falhar no backend, fazer logout do Firebase
        await auth.signOut();
        
        const errorMsg = Array.isArray(data.error) 
          ? data.error.join(', ') 
          : data.error || 'Erro ao criar conta no backend';
        showError(errorMsg);
        submitButton.disabled = false;
        buttonText.textContent = 'Criar Conta';
        return;
      }

      // Cadastro bem-sucedido
      showSuccess('Cadastro realizado com sucesso! Redirecionando...');
      
      // Redirecionar para login após 1 segundo
      setTimeout(() => {
        window.location.href = '<%= login_path %>';
      }, 1000);
      
    } catch (error) {
      console.error('Erro no registro:', error);
      
      let errorMsg = 'Erro ao criar conta. Tente novamente.';
      
      if (error.code === 'auth/email-already-in-use') {
        errorMsg = 'Este email já está em uso.';
      } else if (error.code === 'auth/invalid-email') {
        errorMsg = 'Email inválido.';
      } else if (error.code === 'auth/weak-password') {
        errorMsg = 'Senha muito fraca. Use pelo menos 6 caracteres.';
      } else if (error.message) {
        errorMsg = error.message;
      }
      
      showError(errorMsg);
      submitButton.disabled = false;
      buttonText.textContent = 'Criar Conta';
    }
  });

  function showError(message) {
    errorMessage.textContent = message;
    errorMessage.style.display = 'block';
  }

  function showSuccess(message) {
    successMessage.textContent = message;
    successMessage.style.display = 'block';
  }
</script>

<style>
  .register-container {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #ffffff;
    padding: 20px;
  }

  .register-card {
    background: white;
    border-radius: 0;
    padding: 60px 50px;
    box-shadow: none;
    width: 100%;
    max-width: 600px;
    border: 1px solid #e5e5e5;
  }

  .register-card h1 {
    margin: 0 0 40px 0;
    color: #dc3545;
    font-size: 2.5rem;
    font-weight: 700;
    text-align: center;
    letter-spacing: -0.5px;
  }

  .register-card h2 {
    margin: 0 0 40px 0;
    color: #212529;
    font-size: 1.75rem;
    font-weight: 400;
    text-align: center;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-group label {
    display: block;
    margin-bottom: 10px;
    color: #212529;
    font-weight: 500;
    font-size: 0.95rem;
  }

  .form-group input {
    width: 100%;
    padding: 14px 16px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 1rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    box-sizing: border-box;
    background-color: #fff;
  }

  .form-group input:focus {
    outline: none;
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
  }

  .form-group input:disabled {
    background-color: #f5f5f5;
    cursor: not-allowed;
  }

  .error-message {
    background-color: #f8d7da;
    color: #721c24;
    padding: 14px 16px;
    border-radius: 4px;
    margin-bottom: 24px;
    border: 1px solid #f5c6cb;
    font-size: 0.95rem;
  }

  .btn-primary {
    width: 100%;
    padding: 14px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.15s ease-in-out, transform 0.1s ease-in-out;
    margin-bottom: 20px;
    margin-top: 8px;
  }

  .btn-primary:hover:not(:disabled) {
    background: #c82333;
    transform: translateY(-1px);
  }

  .btn-primary:active:not(:disabled) {
    transform: translateY(0);
  }

  .btn-primary:disabled {
    opacity: 0.65;
    cursor: not-allowed;
    background: #dc3545;
  }

  .success-message {
    background-color: #d4edda;
    color: #155724;
    padding: 14px 16px;
    border-radius: 4px;
    margin-bottom: 24px;
    border: 1px solid #c3e6cb;
    font-size: 0.95rem;
  }

  .register-footer {
    text-align: center;
    margin-top: 32px;
    padding-top: 24px;
    border-top: 1px solid #e5e5e5;
  }

  .register-footer p {
    margin: 0;
    color: #6c757d;
    font-size: 0.95rem;
  }

  .register-footer a {
    color: #dc3545;
    text-decoration: none;
    font-weight: 500;
    transition: color 0.15s ease-in-out;
  }

  .register-footer a:hover {
    color: #c82333;
    text-decoration: underline;
  }

  @media (max-width: 600px) {
    .form-row {
      grid-template-columns: 1fr;
    }
    
    .register-card {
      padding: 30px 20px;
    }
  }
</style>
